# ============================================================================
# LangID Service Environment Configuration
# ============================================================================
# Copy this file to .env and adjust values for your environment.
# This example includes optimizations for a dual Xeon E5-2660 v4 server
# (28 physical cores, 56 logical threads, 64GB RAM). Adjust for your hardware.

# ----------------------------------------------------------------------------
# Core Service Settings
# ----------------------------------------------------------------------------
APP_HOST=0.0.0.0
APP_PORT=8080

# ----------------------------------------------------------------------------
# Storage & Logging
# ----------------------------------------------------------------------------
LOG_DIR=./logs
STORAGE_DIR=./storage
DB_URL=sqlite:///./langid.sqlite

# ----------------------------------------------------------------------------
# Worker Configuration
# ----------------------------------------------------------------------------
# MAX_WORKERS controls the number of parallel worker processes.
# Each worker handles ONE job at a time (synchronously).
# Total system concurrency = MAX_WORKERS
#
# TUNING GUIDELINES:
# - Use ~85% of physical cores (leave some for OS, HTTP server, DB I/O)
# - For dual Xeon E5-2660 v4 (28 physical cores): MAX_WORKERS=24
# - For single CPU systems: Use (physical_cores - 2) to (physical_cores - 4)
# - Do NOT use logical/hyperthreaded core counts for CPU-heavy workloads
# - Monitor CPU usage; if <80%, increase workers. If >95%, decrease.
MAX_WORKERS=24

# ----------------------------------------------------------------------------
# Whisper Model Configuration
# ----------------------------------------------------------------------------
# Model size affects accuracy vs. speed tradeoff
# Options: tiny, base, small, medium, large-v3
# Recommended for CPU: base (fast) or small (balanced)
WHISPER_MODEL_SIZE=base

# Device selection
# Options: cpu, cuda, auto
# For servers without GPU, use 'cpu'
WHISPER_DEVICE=cpu

# Compute precision
# Options: int8, float16, float32
# CRITICAL: Use int8 for CPU to reduce memory bandwidth usage
# int8 provides ~2-3x speedup on CPU with minimal accuracy loss
WHISPER_COMPUTE=int8

# ----------------------------------------------------------------------------
# Performance Tuning (CRITICAL for multi-worker setups)
# ----------------------------------------------------------------------------
# OMP_NUM_THREADS controls how many threads each worker process uses.
# MUST be set to 1 when running multiple workers to prevent thread contention.
#
# WHY THIS MATTERS:
# - faster-whisper uses CTranslate2, which auto-detects CPU cores
# - Without this setting: 24 workers × 14 threads = 336 threads (massive slowdown)
# - With OMP_NUM_THREADS=1: 24 workers × 1 thread = 24 threads (optimal)
#
# WINDOWS NOTE: Set this via NSSM service configuration:
#   nssm set LangIdAPI AppEnvironmentExtra "OMP_NUM_THREADS=1"
# LINUX/macOS: Uncomment the line below
# OMP_NUM_THREADS=1

# ----------------------------------------------------------------------------
# Job Processing
# ----------------------------------------------------------------------------
MAX_FILE_SIZE_MB=100
MAX_RETRIES=3

# ----------------------------------------------------------------------------
# EN/FR Language Gate Configuration
# ----------------------------------------------------------------------------
# Probability thresholds for language detection confidence
LANG_MID_LOWER=0.60
LANG_MID_UPPER=0.79
LANG_DETECT_MIN_PROB=0.60

# Stopword ratio thresholds for mid-zone heuristics
LANG_MIN_STOPWORD_EN=0.15
LANG_MIN_STOPWORD_FR=0.15
LANG_STOPWORD_MARGIN=0.05
LANG_MIN_TOKENS=5

# Strict rejection mode (reject non-EN/FR audio)
ENFR_STRICT_REJECT=false

# ----------------------------------------------------------------------------
# Language Code Format
# ----------------------------------------------------------------------------
# Controls the format of language codes in API responses and dashboard
# Options: iso639-1 (en, fr), iso639-2b (eng, fre), iso639-2t (eng, fra), iso639-3 (eng, fra)
LANG_CODE_FORMAT=iso639-1

# ----------------------------------------------------------------------------
# Cluster Configuration (Optional - for HA deployments)
# ----------------------------------------------------------------------------
# Path to cluster_config.json for multi-node deployments
# Leave commented for standalone single-server deployments
# LANGID_CLUSTER_CONFIG_FILE=C:\ProgramData\LangID\cluster_config.json

# ----------------------------------------------------------------------------
# Database Optimization
# ----------------------------------------------------------------------------
# IMPORTANT: Enable SQLite WAL mode for concurrent worker access
# Run this command once after creating the database:
#   sqlite3 langid.sqlite "PRAGMA journal_mode=WAL;"
# This prevents "database is locked" errors with multiple workers.
